# Проектная работа (Сервис Тех обслуживания)

### Описание:
Проект состоит из 4 сервисов:
* Client (Клиенты и их email)
* Oil (Масла + справочники: Типы масел и вязкости)
* Car (Машины + справочники: Марка/модель и типы моторов)
* Serv (Сервис тех обслуживания)

Каждый из сервисов имеет собственную БД (clientdb, oildb, cardb, servdb). Создание таблиц и добавление данных (справочников) осуществляется при помощи liquibase. Первоначально нужно создать бд.
У каждого сервиса есть Swagger: http://127.0.0.1:8095/swagger-ui/index.html
порты (Client 8095, Oil 8096, Car 8097, Serv 8098)
![4.jpg](res/4.jpg)

Для основной сущьности сервиса (в каждом) производиться валидация в соответствии со схемой JSON.
Написаны тесты позволяющие проверить основной функционал.

Client
![1.jpg](client/res/1.jpg)

Oil
![5.jpg](oil/res/5.jpg)

Car
![3.jpg](car/res/3.jpg)

Serv
![4.jpg](serv/res/4.jpg)

Сборка проекта осуществляется командой mvn clean package -DskipTests каждого сервиса отдельно.
Все приложения запакованы в docker image и поднимаются при помощи compose.

Для защиты от перегрузки в сервисе oil( добавление записи) добавлено ограничение не более 20 запросов в секунду 
и не более 200 в минуту + проверка (метод не выполняется, если 50% запросов за последние 10 секунд были не успешные).

* Созданы 3 jmx (20rps, 21rps, и 1rps) для проверки.

### Запуск с использованием jmeter (Файл приложен в папке res):
* Запрос на добавления записи
![0.jpg](oil/res/0.jpg)

* 21rps
![1.jpg](oil/res/1.jpg)

* Видно что на 21 сработало ограничение (метод не позволяет выполнить более 20 запросов в секунду)
![2.jpg](oil/res/2.jpg)

* 20rps
![3.jpg](oil/res/3.jpg)

* Успешный ответ 
![4.jpg](oil/res/4.jpg)

* Метрики собираются в prometheus (он доступен на порту 9090)
![0.jpg](res/0.jpg)
![1.jpg](res/1.jpg)

* Отображение данных grafana (порт 3000). В правом верхнем углу видно 4 (OK) показывающий что метрики собираются со всех 4 сервисов.
![3.jpg](res/3.jpg)
* Latency в 95р (На сервис подавалась сначала нагрузка в 25rps, после остановки значение изменил на 2 rps)
![2.jpg](res/2.jpg)

* В сервисе serv(to) в основном методе  добавления записи добален повторный вызов при не удаче
![2.jpg](serv/res/2.jpg)

Видна его работа (делает 3 попытки). Сейчас сервис client остановлен
![0.jpg](serv/res/0.jpg)

Если все сервисы запущены то вызов проходит с первого раза.
![1.jpg](serv/res/1.jpg)

*  В методе сервиса car-service получения машины по regNumber добавлен кеш. (Сразу виден прирост в скорости ответа.)
![0.jpg](car/res/0.jpg)

* Вызов метода (происходит обращение к бд)
![1.jpg](car/res/1.jpg)

* Повторный вызов (данные отдаются из кеша)
![2.jpg](car/res/2.jpg)

* Scheduled в сервисе to(serv). С периодичностью в одну минуту выбираются записи
  actual = true и ((dateTo =null и Status ="Не требуется ТО" и пробег менее 10001)
или dateTo меньше на 5 минут от текущего времени и Status ="Проведено ТО"))
По выбраным ид (список) обновляется статус на "Требуется провести ТО"
![3.jpg](serv/res/3.jpg)

* Сервис client  содержит оценку производительности алгоритмов хеша.
  В результате видно что оптимально использовать алгоритм sha256
  (Throughput -операций в секунду), на железе CPU: (i5-14600K), RAM: (32 Gb)
  ![0.jpg](client/res/0.jpg)

* Подписание jar (keytool & jarsigner)

  keytool -genkeypair -alias cert1 -keypass pass123 -validity 365 -storepass stpass123 -keyalg RSA -keystore .\keystore\our_keystore
  keytool -list -storepass stpass123 -keystore .\keystore\our_keystore
  jarsigner -verify .\client\target\client-0.0.1-SNAPSHOT.jar
  jarsigner .\client\target\client-0.0.1-SNAPSHOT.jar -keystore .\keystore\our_keystore cert1

Выпуск самоподписанного сертификата:
![5.jpg](res/5.jpg)

Просмотр к кейсторе:
![6.jpg](res/6.jpg)

Просмотр подписана ли jar (не подписана):
![7.jpg](res/7.jpg)

Подпись jar:
![8.jpg](res/8.jpg)

Просмотр подписана ли jar (подписана):
![9.jpg](res/9.jpg)

* VusualVM. Запускаем VisualVM --> Profile -->JDBC. Выбираем машину по номеру и видим в запросы SELECT (Invocations 1), так как у нас там использовался кеш то повторный вызов метода не производит запрос к БД. 
В запросах видно что выбирались кроме основной сущьности (car) связанные с ней motor_type и mark_model 
![10.jpg](res/10.jpg)

В ответе это тоже видно.
![11.jpg](res/11.jpg)

* В проекте были задействованы:
1)Circuitbreaker,
2)Swagger,
3)Prometheus&Grafana,
4)Docker,
5)Benchmark,
6)VisualVM,
7)Sign,
8)Jmeter,
9)SoftReference,
10)Sheduled,
11)Log,
12)Liquibase

